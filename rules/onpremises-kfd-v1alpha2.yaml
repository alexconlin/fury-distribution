# Copyright (c) 2017-present SIGHUP s.r.l All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

---
kubernetes:
  - path: .spec.kubernetes.dnsZone
    immutable: true
  - path: .spec.kubernetes.controlPlaneAddress
    immutable: true
  - path: .spec.kubernetes.podCidr
    immutable: true
  - path: .spec.kubernetes.svcCidr
    immutable: true
distribution:
  - path: .spec.distribution.modules.networking.type
    immutable: true
  - path: .spec.distribution.modules.logging.type
    immutable: false
    description: "changes to the logging module type have been detected. This will cause the reconfiguration or deletion of the current logging stack."
    reducers:
      - key: distributionModulesLoggingType
        lifecycle: pre-apply
  - path: .spec.distribution.modules.policy.type
    immutable: false
    description: "changes to the policy module type have been detected. This will cause the reconfiguration or deletion of the current policy stack."
    unsupported:
      - to: gatekeeper
        from: kyverno
        reason: "currently, switching from kyverno to gatekeeper is not supported. You need to first remove the current stack with type: none."
      - to: kyverno
        from: gatekeeper
        reason: "currently, switching from gatekeeper to kyverno is not supported. You need to first remove the current stack with type: none."
    reducers:
      - key: distributionModulesPolicyType
        lifecycle: pre-apply
  - path: .spec.distribution.modules.policy.gatekeeper.installDefaultPolicies
    immutable: false
    description: "changes to Gatekeeper default policies option in the policy module have been detected. This will cause the installation or deletion of the default policies."
    reducers:
      - key: distributionModulesPolicyGatekeeperInstallDefaultPolicies
        lifecycle: pre-apply
  - path: .spec.distribution.modules.policy.kyverno.installDefaultPolicies
    immutable: false
    description: "changes to Kyverno default policies option in the policy module have been detected. This will cause the installation or deletion of the default policies."
    reducers:
      - key: distributionModulesPolicyKyvernoInstallDefaultPolicies
        lifecycle: pre-apply
  - path: .spec.distribution.modules.tracing.type
    immutable: false
    description: "changes to the tracing module type have been detected. This will cause the replacement of the current tracing stack (removal or creation)."
    reducers:
      - key: distributionModulesTracingType
        lifecycle: pre-apply
  - path: .spec.distribution.modules.tracing.tempo.backend
    immutable: false
    description: "changes to the tempo backend have been detected. This will cause the reconfiguration of tempo and the deletion of the current minio storage, if minio was disabled"
    reducers:
      - key: distributionModulesTracingTempoBackend
        lifecycle: pre-apply
  - path: .spec.distribution.modules.dr.type
    immutable: false
    description: "changes to the dr module type have been detected. This will cause the replacement of the current DR (velero) stack (removal or creation)."
    reducers:
      - key: distributionModulesDRType
        lifecycle: pre-apply
  - path: .spec.distribution.modules.dr.velero.backend
    immutable: false
    description: "changes to the velero backend have been detected. This will cause the reconfiguration of velero and the deletion of the current minio storage, if minio was disabled"
    reducers:
      - key: distributionModulesDRVeleroBackend
        lifecycle: pre-apply
